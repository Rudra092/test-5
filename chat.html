<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .chat-container { display: flex; flex-direction: column; height: 100vh; }
    .chat-header { padding: 10px; background: #333; color: white; display: flex; justify-content: space-between; align-items: center; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 10px; background: #f4f4f4; }
    .chat-input { display: flex; padding: 10px; background: #ddd; }
    .chat-input input { flex: 1; padding: 10px; }
    .chat-input button { padding: 10px; }
    .message { margin-bottom: 10px; }
    .me { text-align: right; }
    .typing { font-style: italic; color: #666; }
    .status { font-size: 14px; color: #eee; margin-left: 10px; }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div id="friend-name">Friend</div>
      <div id="status" class="status">Offline</div>
    </div>
    <div class="chat-messages" id="messages"></div>
    <div id="typing-indicator" class="typing" style="display: none; padding-left: 10px;">Typing...</div>
    <div class="chat-input">
      <input type="text" id="message" placeholder="Type a message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io('https://test-5-jdfo.onrender.com');
    const user = JSON.parse(localStorage.getItem('user'));
    const friend = JSON.parse(localStorage.getItem('chatFriend'));
    const messagesEl = document.getElementById('messages');
    const typingIndicator = document.getElementById('typing-indicator');
    const statusEl = document.getElementById('status');

    document.getElementById('friend-name').innerText = friend.fullname;

    socket.emit('user-connected', { id: user._id, fullname: user.fullname });

    socket.on('update-status', ({ userId, status }) => {
      if (userId === friend._id) {
        statusEl.innerText = status ? 'Online' : 'Offline';
      }
    });

    socket.on('typing', ({ from }) => {
      if (from === friend._id) typingIndicator.style.display = 'block';
    });

    socket.on('stop-typing', ({ from }) => {
      if (from === friend._id) typingIndicator.style.display = 'none';
    });

    socket.on('chat-message', msg => {
      if ((msg.from === friend._id && msg.to === user._id) || (msg.from === user._id && msg.to === friend._id)) {
        appendMessage(msg);
        if (msg.from === friend._id) {
          socket.emit('mark-seen', { from: friend._id, to: user._id });
        }
      }
    });

    function appendMessage(msg) {
      const div = document.createElement('div');
      div.classList.add('message');
      if (msg.from === user._id) div.classList.add('me');
      div.innerText = msg.text || msg.image || '[media]';
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function sendMessage() {
      const input = document.getElementById('message');
      const text = input.value.trim();
      if (!text) return;
      const msg = { from: user._id, to: friend._id, text };
      socket.emit('chat-message', msg);
      input.value = '';
      socket.emit('stop-typing', { from: user._id, to: friend._id });
    }

    const messageInput = document.getElementById('message');
    let typingTimeout;
    messageInput.addEventListener('input', () => {
      clearTimeout(typingTimeout);
      socket.emit('typing', { from: user._id, to: friend._id });
      typingTimeout = setTimeout(() => {
        socket.emit('stop-typing', { from: user._id, to: friend._id });
      }, 1000);
    });

    // Load previous messages
    fetch(`https://test-5-jdfo.onrender.com/messages/${user._id}/${friend._id}`)
      .then(res => res.json())
      .then(messages => {
        messages.forEach(appendMessage);
      });
  </script>
</body>
</html>
