<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTFâ€‘8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Chat</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.css" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin:0; display:flex; flex-direction:column; height:100vh; }
    header { background:#007bff; color:#fff; padding:1rem; display:flex; align-items:center; justify-content:space-between; }
    #status { font-size:0.9rem; opacity:0.8; margin-left:10px; }
    #chat-box { flex:1; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:10px; }
    .date-group { text-align:center; color:#666; font-size:0.85rem; margin:20px 0 10px; }
    .message-row { display:flex; gap:10px; align-items:flex-end; }
    .avatar { width:32px; height:32px; border-radius:50%; background:#ccc; flex-shrink:0; }
    .message { padding:10px; border-radius:10px; max-width:70%; background:#e1f5fe; position:relative; }
    .message.you { background:#d0f0c0; align-self:flex-end; }
    .timestamp { font-size:0.75rem; color:#666; margin-top:4px; position:absolute; bottom:-18px; right:8px; }
    .seen { font-size:0.7rem; color:#666; margin-left:4px; }
    #typing-indicator { padding:0 1rem; font-style:italic; color:#888; margin-bottom:5px; }
    #message-controls { display:flex; padding:1rem; background:#fff; align-items:center; gap:0.5rem; }
    #message-input { flex:1; padding:10px; border:1px solid #ccc; border-radius:8px; }
    button { padding:10px 15px; border:none; background:#007bff; color:#fff; border-radius:8px; cursor:pointer; }
    label.upload { cursor:pointer; }
    label.upload svg { width:24px; height:24px; fill:#007bff; }
    .file-preview { max-width:200px; border-radius:6px; margin-top:8px; }
    .drop-zone { border:2px dashed #ccc; padding:20px; text-align:center; margin:10px; border-radius:8px; }
    .drop-zone.dragover { background:#e1f5fe; }
  </style>
</head>
<body>
  <header>
    <div>
      Chat with <strong id="friend-name">...</strong>
      <span id="status">(Offline)</span>
    </div>
  </header>

  <div id="chat-box"></div>
  <div id="typing-indicator"></div>

  <div id="message-controls">
    <label class="upload" title="Attach File">
      âž•
      <input type="file" id="file-upload" accept="image/*" style="display:none;" />
    </label>
    <input type="text" id="message-input" placeholder="Type your messageâ€¦" />
    <button onclick="toggleEmoji()">ðŸ˜Š</button>
    <button onclick="sendMessage()">Send</button>
  </div>

  <emoji-picker id="emoji-picker" style="display:none; position:absolute; bottom:70px; right:20px;"></emoji-picker>

  <script>
    const socket = io('https://test-5-jdfo.onrender.com');
    const user = JSON.parse(localStorage.getItem('user'));
    const friendId = new URLSearchParams(window.location.search).get('fid');
    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('message-input');
    const typingIndicator = document.getElementById('typing-indicator');
    const fileInput = document.getElementById('file-upload');
    const friendNameEl = document.getElementById('friend-name');
    const statusEl = document.getElementById('status');

    let friendData = {};

    fetch(`https://test-5-jdfo.onrender.com/me/${friendId}`)
      .then(r=>r.json()).then(d => { friendData = d.user; friendNameEl.textContent = friendData.fullname; });

    socket.emit('user-connected', { id: user._id, name: user.fullname });
    socket.on('update-status', ({ userId, status }) => {
      if (userId === friendId) statusEl.textContent = status ? 'Online' : 'Offline';
    });

    input.addEventListener('input', () => {
      socket.emit('typing', { from: user._id, to: friendId });
    });

    socket.on('typing', ({ from }) => {
      if (from === friendId) {
        typingIndicator.textContent = `${friendData.fullname} is typingâ€¦`;
        clearTimeout(typingIndicator.timer);
        typingIndicator.timer = setTimeout(() => typingIndicator.textContent = '', 1500);
      }
    });

    let lastDate;
    function renderMessage(msg) {
      const dt = new Date(msg.time).toDateString();
      if (dt !== lastDate) {
        const grp = document.createElement('div');
        grp.className = 'date-group';
        grp.textContent = dt;
        chatBox.append(grp);
        lastDate = dt;
      }
      const row = document.createElement('div');
      row.className = 'message-row';
      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      avatar.src = msg.from === user._id ? user.avatar || '' : (friendData.avatar || '');
      row.append(avatar);

      const msgDiv = document.createElement('div');
      msgDiv.className = 'message' + (msg.from === user._id ? ' you' : '');
      if (msg.image) {
        const img = document.createElement('img');
        img.src = msg.image;
        img.className = 'file-preview';
        msgDiv.append(img);
      }
      if (msg.text) msgDiv.append(document.createTextNode(msg.text));

      const time = document.createElement('div');
      time.className = 'timestamp';
      time.textContent = new Date(msg.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      msgDiv.append(time);

      if (msg.from === user._id && msg.seen) {
        const seen = document.createElement('span');
        seen.className = 'seen';
        seen.textContent = 'Seen';
        msgDiv.append(seen);
      }

      row.append(msgDiv);
      chatBox.append(row);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    socket.on('chat-message', msg => renderMessage(msg));

    function sendMessage() {
      const text = input.value.trim(), file = fileInput.files[0];
      if (!text && !file) return;
      const msg = { from:user._id,to:friendId,text, time:new Date().toISOString() };
      function emitMsg() {
        socket.emit('chat-message', msg);
        input.value = ''; fileInput.value = '';
      }
      if (file) {
        const reader = new FileReader();
        reader.onload = () => { msg.image = reader.result; emitMsg(); };
        reader.readAsDataURL(file);
      } else emitMsg();
    }

    function toggleEmoji() { const pk = document.getElementById('emoji-picker'); pk.style.display = pk.style.display==='none'?'block':'none'; }
    document.getElementById('emoji-picker').addEventListener('emoji-click', e => input.value += e.detail.unicode);

    // Drag & drop support
    document.body.addEventListener('dragover', e=>{ e.preventDefault(); e.dataTransfer.dropEffect='copy'; });
    document.body.addEventListener('drop', e=>{
      e.preventDefault();
      const f = e.dataTransfer.files[0];
      if (f && f.type.startsWith('image/')) {
        fileInput.files = e.dataTransfer.files;
        sendMessage();
      }
    });
  </script>
</body>
</html>
